// Reqvolt Prisma Schema - 21 tables
// Database: Neon PostgreSQL 16 with pgvector

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum WorkspaceRole {
  Admin
  Member
}

enum SourceType {
  MEETING_NOTES
  CUSTOMER_FEEDBACK
  WORKSHOP_NOTES
  RETRO_NOTES
  INTERVIEW_TRANSCRIPT
  TRANSCRIPT
  EMAIL
  PDF
  DOCX
  OTHER
}

enum PackReviewStatus {
  draft
  in_review
  partially_approved
  approved
  locked
}

enum HealthStatus {
  healthy
  stale
  at_risk
  outdated
}

enum ExtractionQuality {
  good
  partial
  failed
}

enum SourceStatus {
  pending
  processing
  completed
  failed
}

enum EvidenceEntityType {
  story
  acceptance_criteria
}

enum ConfidenceLevel {
  high
  medium
  low
}

enum EvolutionStatus {
  new
  strengthened
  contradicted
  unchanged
  removed
}

enum QARuleCode {
  VAGUE_TERM
  UNTESTABLE
  OVERLOADED_AC
  MISSING_CLAUSE
  NO_EVIDENCE
  WEAK_EVIDENCE_ONLY
  SEMANTIC_DUPLICATE
  LONG_STORY
}

enum QASeverity {
  high
  medium
  low
}

enum QAResolvedBy {
  fixed
  dismissed
}

enum PushStatus {
  success
  failed
  skipped
}

enum ApprovalStatus {
  approved
  rejected
}

model Workspace {
  id                   String   @id @default(cuid())
  name                 String
  onboardingCompleted  Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  aiGenerationEnabled      Boolean @default(true)
  aiQaAutoFixEnabled       Boolean @default(true)
  aiSelfReviewEnabled      Boolean @default(true)
  aiTopicExtractionEnabled Boolean @default(true)
  aiEmbeddingEnabled       Boolean @default(true)

  healthWeights           Json    @default("{\"sourceDrift\":0.30,\"evidenceCoverage\":0.25,\"qaPassRate\":0.20,\"deliveryFeedback\":0.15,\"sourceAge\":0.10}")
  similarityThreshold     Float   @default(0.78)
  jiraRejectionStatuses   String[] @default(["Rejected", "Won't Do", "Cancelled"])
  jiraSignalWords         String[] @default(["unclear", "ambiguous", "question", "assumption", "wrong", "missing", "confused", "what does", "what do you mean"])
  mondayRejectionStatuses String[] @default(["Stuck", "Rejected"])

  members   WorkspaceMember[]
  projects  Project[]
  auditLogs AuditLog[]
  templates Template[]
  glossary  GlossaryEntry[]
  uploadSessions UploadSession[]
  mondayConnection MondayConnection?
  jiraConnection JiraConnection?
  storyExports StoryExport[]
  apiKeys ApiKey[]
  notifications Notification[]
  notificationPreferences NotificationPreference[]
  storyFeedback StoryFeedback[]
  packFeedback PackFeedback[]
  modelUsage ModelUsage[]
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole
  email       String
  invitedAt   DateTime      @default(now())
  joinedAt    DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

model Project {
  id              String   @id @default(cuid())
  workspaceId     String
  name            String
  clientName      String?
  forwardingEmail String?  @unique @db.VarChar(255)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  sources   Source[]
  packs     Pack[]
  @@index([workspaceId])
}

model Source {
  id                 String            @id @default(cuid())
  projectId          String
  workspaceId        String
  type               SourceType
  name               String
  content            String            @db.Text
  metadata           Json?
  extractionQuality  ExtractionQuality?
  status             SourceStatus      @default(pending)
  deletedAt         DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  currentVersionId     String?
  sourceConnectionType String  @default("uploaded")
  externalSourceId     String?  @db.VarChar(500)
  externalSourceUrl    String?  @db.VarChar(1000)
  lastSyncedAt         DateTime?
  syncStatus           String   @default("manual")

  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  chunks  SourceChunk[]
  versions SourceVersion[]
  chunkDiffs SourceChunkDiff[]
  changeImpacts SourceChangeImpact[]
  @@index([projectId])
  @@index([workspaceId])
  @@index([deletedAt])
  @@index([projectId, deletedAt])
}

model SourceChunk {
  id         String   @id @default(cuid())
  sourceId   String
  content    String   @db.Text
  tokenCount Int      @default(0)
  chunkIndex Int
  metadata   Json?
  embedding  Unsupported("vector(1536)")?

  source Source @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  evidenceLinks EvidenceLink[]

  @@index([sourceId])
}

model Pack {
  id          String   @id @default(cuid())
  projectId   String
  workspaceId String
  name        String
  reviewStatus PackReviewStatus @default(draft)
  healthScore  Int?
  healthStatus HealthStatus @default(healthy)
  lastHealthCheck DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project  Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  versions PackVersion[]
  healthHistory PackHealth[]
  storyExports StoryExport[]
  deliveryFeedback DeliveryFeedback[]
  changeImpacts SourceChangeImpact[]
  storyFeedback StoryFeedback[]
  packFeedback PackFeedback[]
  modelUsage   ModelUsage[]
  @@index([projectId])
  @@index([workspaceId])
}

model PackVersion {
  id              String   @id @default(cuid())
  packId          String
  versionNumber   Int
  sourceIds       Json     // string[]
  summary         String?  @db.Text
  nonGoals        String?  @db.Text
  openQuestions   Json?
  assumptions     Json?
  decisions       Json?
  risks           Json?
  generationConfig Json?
  changeAnalysis  Json?
  editLockUserId  String?
  generationConfidence Json?
  confidenceScore Int?
  confidenceLevel String?
  selfReviewRun   Boolean  @default(false)
  selfReviewPassed Boolean?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  pack           Pack            @relation(fields: [packId], references: [id], onDelete: Cascade)
  stories        Story[]
  qaFlags        QAFlag[]
  reviewLinks    ReviewLink[]
  mondayPushLogs MondayPushLog[]
  storyExports   StoryExport[]
  @@index([packId])
}

model Story {
  id            String   @id @default(cuid())
  packVersionId String
  sortOrder     Int
  persona       String   @db.Text
  want          String   @db.Text
  soThat        String   @db.Text
  deletedAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  packVersion        PackVersion        @relation(fields: [packVersionId], references: [id], onDelete: Cascade)
  acceptanceCriteria AcceptanceCriteria[]
  storyApprovals     StoryApproval[]
  mondayPushLogs     MondayPushLog[]
  storyExports       StoryExport[]
  deliveryFeedback   DeliveryFeedback[]
  comments           StoryComment[]
  storyFeedback      StoryFeedback[]
  @@index([packVersionId])
}

enum StoryRating {
  UP
  DOWN
}

enum PackRating {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

model StoryFeedback {
  id          String       @id @default(cuid())
  storyId     String
  story       Story        @relation(fields: [storyId], references: [id], onDelete: Cascade)
  packId      String
  pack        Pack         @relation(fields: [packId], references: [id], onDelete: Cascade)
  workspaceId String
  workspace   Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId      String
  rating      StoryRating
  createdAt   DateTime     @default(now())

  @@unique([storyId, userId])
  @@index([packId])
  @@index([workspaceId, createdAt])
}

model PackFeedback {
  id          String      @id @default(cuid())
  packId      String
  pack        Pack        @relation(fields: [packId], references: [id], onDelete: Cascade)
  workspaceId String
  workspace   Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId      String
  rating      PackRating
  comment     String?     @db.Text
  createdAt   DateTime    @default(now())

  @@unique([packId, userId])
  @@index([workspaceId, createdAt])
}

model ModelUsage {
  id           String    @id @default(cuid())
  workspaceId  String
  workspace    Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  model        String
  task         String
  inputTokens  Int
  outputTokens Int
  durationMs   Int
  packId       String?
  pack         Pack?      @relation(fields: [packId], references: [id], onDelete: SetNull)
  createdAt    DateTime  @default(now())

  @@index([workspaceId, createdAt])
  @@index([task, createdAt])
}

model StoryComment {
  id             String    @id @default(cuid())
  storyId        String
  packVersionId  String
  workspaceId    String
  parentId       String?
  content        String    @db.Text
  mentions       String[]  @default([])
  createdBy      String    @db.VarChar(255)
  resolvedAt     DateTime?
  resolvedBy     String?   @db.VarChar(255)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  story   Story         @relation(fields: [storyId], references: [id], onDelete: Cascade)
  parent  StoryComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies StoryComment[] @relation("CommentReplies")
  @@index([storyId])
  @@index([workspaceId])
  @@index([parentId])
}

model AcceptanceCriteria {
  id            String   @id @default(cuid())
  storyId       String
  sortOrder     Int
  given         String   @db.Text
  when         String   @db.Text
  then         String   @db.Text
  deletedAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)
  @@index([storyId])
}

model EvidenceLink {
  id               String           @id @default(cuid())
  entityType       EvidenceEntityType
  entityId         String
  sourceChunkId    String
  confidence       ConfidenceLevel
  evolutionStatus  EvolutionStatus   @default(unchanged)
  previousConfidence String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  sourceChunk SourceChunk @relation(fields: [sourceChunkId], references: [id], onDelete: Cascade)
  @@index([entityType, entityId])
  @@index([sourceChunkId])
}

model QAFlag {
  id             String      @id @default(cuid())
  packVersionId  String
  entityType     EvidenceEntityType
  entityId       String
  ruleCode       QARuleCode
  severity       QASeverity
  message        String      @db.Text
  suggestedFix   String?     @db.Text
  resolvedBy     QAResolvedBy?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  packVersion PackVersion @relation(fields: [packVersionId], references: [id], onDelete: Cascade)
  @@index([packVersionId])
}

model ReviewLink {
  id             String    @id @default(cuid())
  packVersionId  String
  token          String    @unique
  expiresAt      DateTime
  revokedAt      DateTime?
  viewCount      Int       @default(0)
  lastViewedAt   DateTime?
  createdAt      DateTime  @default(now())

  packVersion PackVersion   @relation(fields: [packVersionId], references: [id], onDelete: Cascade)
  comments   ReviewComment[]
  @@index([packVersionId])
  @@index([token])
}

model ReviewComment {
  id          String    @id @default(cuid())
  reviewLinkId String
  entityType  EvidenceEntityType
  entityId    String
  content     String    @db.Text
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())

  reviewLink ReviewLink @relation(fields: [reviewLinkId], references: [id], onDelete: Cascade)
  @@index([reviewLinkId])
}

model AuditLog {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  action      String
  entityType  String
  entityId    String?
  metadata    Json?
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId])
  @@index([userId])
  @@index([workspaceId, createdAt])
}

model Template {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  content     Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId])
}

model GlossaryEntry {
  id          String   @id @default(cuid())
  workspaceId String
  term        String
  definition  String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId])
}

model GenerationCache {
  id        String   @id @default(cuid())
  cacheKey  String   @unique
  response  Json
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
}

model StoryApproval {
  id         String         @id @default(cuid())
  storyId    String
  approvedBy String
  approvedAt DateTime
  status     ApprovalStatus

  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)
  @@index([storyId])
}

model UploadSession {
  id                   String    @id @default(cuid())
  workspaceId          String
  userId               String
  objectKey            String
  expectedSize         BigInt
  expectedContentType  String
  expiresAt            DateTime
  consumedAt           DateTime?
  createdAt            DateTime  @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId])
  @@index([expiresAt])
}

model MondayConnection {
  id              String   @id @default(cuid())
  workspaceId     String   @unique
  mondayBoardId   String
  mondayGroupId   String
  fieldMapping    Json
  accessToken     String   @db.Text
  refreshToken    String?  @db.Text
  connectedAt     DateTime
  connectedBy     String

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model JiraConnection {
  id             String    @id @default(cuid())
  workspaceId    String    @unique
  cloudId        String
  siteUrl        String    @db.VarChar(500)
  accessToken    String    @db.Text
  refreshToken   String    @db.Text
  tokenExpiresAt DateTime
  scopes         String    @db.VarChar(500)
  isActive       Boolean   @default(true)
  lastSyncedAt   DateTime?
  syncError      String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model MondayPushLog {
  id             String     @id @default(cuid())
  packVersionId  String
  storyId        String
  mondayItemId   String
  pushedAt       DateTime
  pushedBy       String
  status         PushStatus
  errorMessage   String?    @db.Text

  packVersion PackVersion @relation(fields: [packVersionId], references: [id], onDelete: Cascade)
  story      Story        @relation(fields: [storyId], references: [id], onDelete: Cascade)
  @@index([packVersionId])
  @@index([storyId])
}

model SourceVersion {
  id            String   @id @default(cuid())
  sourceId      String
  versionNumber Int
  content       String   @db.Text
  contentHash   String   @db.VarChar(64)
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now())

  source        Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  chunkDiffsOld SourceChunkDiff[] @relation("OldVersion")
  chunkDiffsNew SourceChunkDiff[] @relation("NewVersion")
  changeImpacts SourceChangeImpact[]

  @@unique([sourceId, versionNumber])
  @@index([sourceId])
}

model SourceChunkDiff {
  id              String        @id @default(cuid())
  sourceId        String
  oldVersionId    String?
  newVersionId    String
  diffType        String
  oldChunkId      String?
  newChunkId      String?
  similarityScore Float?
  createdAt       DateTime      @default(now())

  source     Source        @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  oldVersion SourceVersion? @relation("OldVersion", fields: [oldVersionId], references: [id])
  newVersion SourceVersion  @relation("NewVersion", fields: [newVersionId], references: [id])

  @@index([sourceId, newVersionId])
}

model PackHealth {
  id         String   @id @default(cuid())
  packId     String
  score      Int
  status     String
  factors    Json
  computedAt DateTime @default(now())

  pack Pack @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@index([packId, computedAt])
}

model StoryExport {
  id                     String    @id @default(cuid())
  storyId                String
  packVersionId          String
  packId                 String
  workspaceId            String
  externalSystem         String
  externalId             String    @db.VarChar(255)
  externalUrl            String?   @db.VarChar(1000)
  externalStatus         String?   @db.VarChar(100)
  externalStatusCategory String?   @db.VarChar(50)
  lastSyncedAt           DateTime?
  syncError              String?   @db.Text
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  story          Story          @relation(fields: [storyId], references: [id], onDelete: Cascade)
  packVersion    PackVersion    @relation(fields: [packVersionId], references: [id])
  pack           Pack           @relation(fields: [packId], references: [id])
  workspace      Workspace     @relation(fields: [workspaceId], references: [id])
  deliveryFeedback DeliveryFeedback[]

  @@unique([storyId, externalSystem, packVersionId])
  @@index([packId])
  @@index([workspaceId, externalSystem])
  @@index([packVersionId, externalSystem])
}

model DeliveryFeedback {
  id                String    @id @default(cuid())
  storyExportId     String
  storyId           String
  packId            String
  feedbackType      String
  externalAuthor    String?   @db.VarChar(255)
  content           String?   @db.Text
  externalCreatedAt DateTime?
  matchedSignalWords String[]
  isResolved        Boolean   @default(false)
  resolvedAt        DateTime?
  resolvedBy        String?   @db.VarChar(255)
  resolutionNote    String?   @db.Text
  createdAt         DateTime  @default(now())

  storyExport StoryExport @relation(fields: [storyExportId], references: [id], onDelete: Cascade)
  story       Story       @relation(fields: [storyId], references: [id])
  pack        Pack        @relation(fields: [packId], references: [id])

  @@index([packId])
  @@index([storyId])
  @@index([storyExportId, isResolved])
}

model SourceChangeImpact {
  id                 String    @id @default(cuid())
  sourceId           String
  packId             String
  sourceVersionId    String
  affectedStoryIds   String[]
  affectedStoryCount Int
  affectedAcCount    Int
  impactSummary      String?   @db.Text
  summaryPending     Boolean   @default(false)
  retryCount         Int       @default(0)
  severity           String    @default("moderate")
  isAcknowledged     Boolean   @default(false)
  acknowledgedAt     DateTime?
  acknowledgedBy     String?   @db.VarChar(255)
  createdAt          DateTime  @default(now())

  source       Source       @relation(fields: [sourceId], references: [id])
  pack         Pack         @relation(fields: [packId], references: [id])
  sourceVersion SourceVersion @relation(fields: [sourceVersionId], references: [id])

  @@index([packId])
  @@index([packId, isAcknowledged])
}

model ApiKey {
  id           String    @id @default(cuid())
  workspaceId String
  name         String    @db.VarChar(255)
  keyHash      String    @db.VarChar(64)
  keyPrefix    String    @db.VarChar(10)
  lastUsedAt   DateTime?
  requestCount Int       @default(0)
  isRevoked    Boolean   @default(false)
  revokedAt    DateTime?
  createdBy    String    @db.VarChar(255)
  createdAt    DateTime  @default(now())
  expiresAt    DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([keyHash])
}

model Notification {
  id              String    @id @default(cuid())
  workspaceId     String
  userId          String    @db.VarChar(255)
  type            String
  title           String    @db.VarChar(500)
  body            String?   @db.Text
  link            String?   @db.VarChar(1000)
  relatedPackId   String?
  relatedSourceId String?
  isRead          Boolean   @default(false)
  readAt          DateTime?
  createdAt       DateTime  @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([userId, workspaceId])
  @@index([userId, isRead, createdAt])
}

model NotificationPreference {
  id                     String    @id @default(cuid())
  workspaceId            String
  userId                 String    @db.VarChar(255)
  emailFrequency         String    @default("daily")
  notifySourceChanges    Boolean   @default(true)
  notifyDeliveryFeedback Boolean   @default(true)
  notifyHealthDegraded   Boolean   @default(true)
  notifyEmailIngested    Boolean   @default(true)
  notifyMentions         Boolean   @default(true)
  notifyReplies          Boolean   @default(true)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
}
